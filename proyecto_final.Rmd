---
title: "Proyecto final módulo 3"
author: "Equipo - 11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	fig.align = "center",
	fig.dim = c(5.0, 4.0),
	fig.pos = "H",
# Agregamos configuraciones para evitar mensajes de advertencias y de errores en el archivo
	message = FALSE,
	warning = FALSE,
	error = F
)


```

# Integrantes:

+ Bryant Canseco Hernández. Rol: Administrador
+ Diego Gómez Santiago. Rol: Colaborador 1
+ Fernando Alvarado Palacios. Rol: Colaborador 2

```{r}
# Cargamos las librerías necesarias para conectarnos y manipular la base de datos
# Cargamos las librerías necesarias para conectarnos y manipular la base de datos
library(dplyr)
library(ggplot2)
library(DBI)
library(dbplyr)
library(RSQLite)
library(tidyr)
library(lubridate)
library(stringr)
library(knitr)        # Librería para hacer tablas más bonitas
library(visdat)       # Ver datos faltantes en un df
library(skimr)
library(DiagrammeR)
library(readr)
library(countrycode)
library(naniar)
library(esquisse)
library(patchwork)    # Orden de las librerías

library(multcomp) #Pruebas de hipotesisi




```



```{r Data}

setwd("C:/Users/ferna/Documents/Proyectos_Diplomado/diplo-modulo3-equipo-11/Data")
# Conexión a la base de datos
conn <- dbConnect(SQLite(), "baseball.db")

```





```{r}


# Listar tablas de la base
tablas <- dbListTables(conn)

# Crear objetos R para cada tabla
for (tabla in tablas) {
  assign(tabla, dbReadTable(conn, tabla))
}

# Resumen de variables para cada tabla usando skim()
skim(bateo)
skim(escuelas)
skim(escuelasJugadores)
skim(field)
skim(nombres)
skim(pitcheo)
skim(salarios)
skim(salonFama)

# Diagrama de relaciones principales entre las tablas
#grViz(" digraph baseball_db {
#  
#  node [shape = box, style=filled, fillcolor=lightblue, #fontname=Helvetica]
#  
#  bateo -> nombres [label = 'playerID']
#  pitcheo -> nombres [label = 'playerID']
#  field -> nombres [label = 'playerID']
#  salarios -> nombres [label = 'playerID']
#  escuelasJugadores -> nombres [label = 'playerID']
#  escuelasJugadores -> escuelas [label = 'schoolID']
#  salonFama -> nombres [label = 'playerID']
#
#  nombres [shape=ellipse, fillcolor=lightgreen]
#  escuelas [shape=ellipse, fillcolor=lightpink]
#}
#")

```
Se analizaron 8 tablas de baseball.db usando skimr, mostrando que en general las bases están limpias, aunque nombres presenta valores faltantes en variables de fallecimiento, como era esperable.

El diagrama de relaciones muestra que nombres es la tabla central, conectando con desempeño (bateo, pitcheo, field), salarios (salarios), formación (escuelasJugadores) y logros (salonFama).

No se detectaron duplicados importantes en playerID, y las tablas permiten análisis posteriores con poca limpieza adicional.



### Diccionario 

Como no se proporciono un diccionario de que significaban las variables nosotros lo creamos investigando un poco del deporte: 



#### Tabla  bateo (bateo de jugadores en partidos)

Descripción de las columnas:
- playerID: Identificador único del jugador.
- yearID: Año en que se registraron las estadísticas.
- stint: Número de veces que un jugador cambia de equipo en un año (1 = primera aparición, 2 = segunda, etc.).
- teamID: Abreviatura del equipo en el que jugó.
- lgID: Liga a la que pertenece el equipo (NL = National League, AL = American League).
- G: Juegos jugados (Games).
- AB: Turnos al bate oficiales (At Bats).
- R: Carreras anotadas (Runs).
- H: Hits (veces que el jugador consiguió llegar a una base mediante un golpe válido).
- X2B: Dobles (Hits que permiten llegar a segunda base directamente).
- X3B: Triples (Hits que permiten llegar a tercera base directamente).
- HR: Home runs (jonrones; cuando la bola sale del campo y el jugador anota directamente).
- RBI: Carreras impulsadas (Runs Batted In; número de carreras que el bateador ayudó a anotar).
- SB: Bases robadas (Stolen Bases; cuántas veces avanzó de base corriendo antes de ser puesto out).
- CS: Intentos de robo de base fallidos (Caught Stealing).
- BB: Bases por bolas recibidas (Walks; cuando el lanzador da cuatro bolas malas y el jugador avanza a primera base).
- SO: Ponches recibidos (Strikeouts; cuando es eliminado por fallar al batear).
- IBB: Bases por bolas intencionales (cuando el lanzador decide no enfrentar al bateador y lo envía directo a primera).
- HBP: Veces golpeado por un lanzamiento (Hit By Pitch).
- SH: Toques de sacrificio (Sacrifice Hits; avanza corredores sacrificando su propio turno).
- SF: Flies de sacrificio (Sacrifice Flies; elevado que permite anotar una carrera).
- GIDP: Doble matanza en la que participó (Ground Into Double Play; el jugador batea para doble eliminación).

#### Tabla escuelas (escuelas de jugadores)

Descripción de las columnas:
- schoolID: Identificador único de la escuela (un código para identificarla fácilmente).
- name_full: Nombre completo de la escuela (por ejemplo "Universidad de Stanford" o "Texas A&M University").
- city: Ciudad donde se encuentra la escuela.
- state: Estado (o región) donde está ubicada la escuela.
- country: País donde se encuentra la escuela.

#### Tabla escuelasJugadores  (escuelas de los Jugadores)

Descripción de las columnas:
- playerID: Identificador único del jugador (permite saber de qué jugador estamos hablando).
- schoolID: Identificador único de la escuela que asistió el jugador (se puede unir con la tabla de escuelas para saber el nombre completo).
- yearID: Año en el que el jugador asistió a esa escuela.

#### Tabla field (estadísticas de campo de los  jugadores)

Descripción de las columnas:
- playerID: Identificador único del jugador.
- yearID: Año de la estadística.
- stint: Número de aparición en el año (por cambios de equipo o posiciones).
- teamID: Abreviatura del equipo.
- lgID: Liga a la que pertenece el equipo (NL o AL).
- POS: Posición de juego (por ejemplo, 1B = primera base, SS = shortstop, OF = outfielder).
- G: Juegos jugados en esa posición.
- GS: Juegos iniciados (Games Started) en esa posición.
- InnOuts: Número de outs realizados mientras jugaba (cada inning tiene 3 outs).
- PO: Putouts; outs hechos directamente (por ejemplo, capturar una bola voladora).
- A: Assists; asistencias en jugadas defensivas.
- E: Errors; errores cometidos en el fildeo.
- DP: Doble plays en los que participó.
- PB: Passed Balls; para receptores (cátchers), errores al recibir lanzamientos.
- WP: Wild Pitches; lanzamientos malos del pitcher (a veces se registran si el receptor no logra detenerlos).
- SB: Bases robadas permitidas (cuando el cátcher o equipo permite que un corredor robe base).
- CS: Caught Stealing; corredores atrapados tratando de robar base.
- ZR: Zone Rating; medida avanzada de qué tan efectivo es un jugador cubriendo su zona defensiva.

#### Tabla nombres (información personal de jugadores)

Descripción de las columnas:
- playerID: Identificador único del jugador.
- birthYear: Año de nacimiento.
- birthMonth: Mes de nacimiento.
- birthDay: Día de nacimiento.
- birthCountry: País de nacimiento.
- birthState: Estado o región de nacimiento.
- birthCity: Ciudad de nacimiento.
- deathYear: Año de fallecimiento (NA si el jugador sigue vivo).
- deathMonth: Mes de fallecimiento.
- deathDay: Día de fallecimiento.
- deathCountry: País donde falleció.
- deathState: Estado donde falleció.
- deathCity: Ciudad donde falleció.
- nameFirst: Primer nombre del jugador.
- nameLast: Apellido del jugador.
- nameGiven: Nombre completo de pila que usaba (puede incluir segundo nombre o variaciones).
- weight: Peso del jugador (en libras).
- height: Estatura del jugador (en pulgadas).
- bats: Lado desde el cual batea el jugador (R = Right, L = Left, B = Both).
- throws: Lado con el que lanza el jugador (R = Right, L = Left).
- debut: Fecha del debut en las Grandes Ligas.
- finalGame: Fecha del último partido en Grandes Ligas.
- retroID: Código de identificación usado por la base de datos RetroSheet.
- bbrefID: Código usado en Baseball-Reference (otra fuente de datos de béisbol).

#### Tabla pitcheo (estadísticas de pitcheo de jugadores)

Descripción de las columnas:
- playerID: Identificador único del jugador.
- yearID: Año de la estadística.
- stint: Número de aparición (cambio de equipo o rol en el mismo año).
- teamID: Abreviatura del equipo.
- lgID: Liga del equipo (NL o AL).
- W: Juegos ganados (Wins).
- L: Juegos perdidos (Losses).
- G: Juegos en los que participó lanzando.
- GS: Juegos en los que fue pitcher abridor (Games Started).
- CG: Juegos completos (el pitcher lanzó todo el partido).
- SHO: Juegos en los que no permitió carreras (Shutouts).
- SV: Juegos salvados (Saves; cuando un pitcher cierra exitosamente un partido ganado).
- IPouts: Número de outs logrados (cada inning tiene 3 outs).
- H: Hits permitidos.
- ER: Carreras limpias permitidas (Earned Runs; no incluyen errores defensivos).
- HR: Home runs permitidos.
- BB: Bases por bolas otorgadas (Walks concedidos).
- SO: Ponches realizados (Strikeouts).
- BAOpp: Promedio de bateo de los rivales (batting average of opponents).
- ERA: Promedio de carreras limpias (Earned Run Average; mide efectividad del pitcher).
- IBB: Bases por bolas intencionales otorgadas.
- WP: Lanzamientos descontrolados (Wild Pitches).
- HBP: Bateadores golpeados por lanzamiento.
- BK: Balks (movimientos ilegales del pitcher).
- BFP: Total de bateadores enfrentados (Batters Faced by Pitcher).
- GF: Juegos terminados por el pitcher (cuando fue el último lanzador de su equipo en el juego).
- R: Total de carreras permitidas (incluyendo las no limpias).
- SH: Toques de sacrificio permitidos.
- SF: Flies de sacrificio permitidos.
- GIDP: Doble plays en los que su equipo participó cuando él lanzaba.

#### Tabla  salarios (salarios de jugadores)

Descripción de las columnas:
- yearID: Año en que se pagó el salario.
- teamID: Abreviatura del equipo que pagó el salario.
- lgID: Liga a la que pertenece el equipo (NL o AL).
- playerID: Identificador único del jugador.
- salary: Salario anual del jugador (en dólares).

#### Tabla  salonFama (candidatos al Salón de la Fama)

Descripción de las columnas:
- playerID: Identificador único del jugador.
- yearID: Año en el que ocurrió la votación.
- votedBy: Método de votación (por ejemplo, "BBWAA" para la asociación de escritores de béisbol).
- ballots: Número total de boletas en las que fue incluido el jugador ese año.
- needed: Número de votos requeridos para ser elegido (usualmente el 75% de las boletas).
- votes: Número de votos que recibió el jugador.
- inducted: Indica si el jugador fue finalmente inducido ("Y" = sí, "N" = no).
- category: Categoría en la que fue evaluado (puede ser "Player", "Manager", "Umpire", etc.).
- needed_note: Notas adicionales sobre los requisitos especiales para ser elegido.








```{r objetos_tablas}
# Leemos cada tabla de la base de datos y creamos un objeto en R con el mismo nombre
for (tabla in tablas) {
  assign(tabla, dbReadTable(conn, tabla))
}

# Inspeccionamos la estructura de la tabla 'nombres'
head(nombres)
str(nombres)
```

```{r resumen-tablas, message=FALSE, warning=FALSE}
# Creamos una tabla resumen con el número de filas por cada tabla
resumen_tablas <- tibble::tibble(
  nombre_tabla = tablas,
  num_filas = sapply(tablas, function(t) nrow(get(t)))
)

# Mostramos la tabla 
knitr::kable(resumen_tablas, caption = "Resumen de tablas en la base de datos 'baseball.db'")
```


# Analisis de datos faltantes 



```{r}
muestreo_bate <- bateo %>% sample_n(1000)

vis_dat(muestreo_bate)
vis_miss(muestreo_bate)



filtrado_muestreo_base <- muestreo_bate %>% 
   select(CS, IBB, SF, GIDP)

vis_miss(filtrado_muestreo_base)
```

#### Análisis de datos faltantes en la tabla Bateo

En la tabla **Observaciones** (que nos muestra el desempeño ofensivo de jugadores de béisbol en diferentes equipos y años), podemos observar que, aunque solo falta el **5.5%** de los datos, estos datos faltantes se concentran en las columnas **CS**, **IBB**, **SF** y **GIDP**.

Haciendo un análisis más exhaustivo, en estas cuatro columnas el número total de datos faltantes es del **27%**, donde en la mayoría de los casos los NAs ocurren en toda la fila. Esto podría deberse a que los jugadores tienen distintas posiciones y no todos participan de la misma manera en la ofensiva.



```{r}
vis_dat(escuelas)
vis_miss(escuelas)
```

### Análisis de datos faltantes en la tabla Bateo

En esta tabla contamos con solo **2.2%** de datos faltantes, lo cual no afectará nuestro análisis. Podemos atribuir estos NAs a que algunos jugadores no asistieron a la universidad o no se registraron en la base de datos.


```{r}
vis_dat(escuelasJugadores)
vis_miss(escuelasJugadores)
```

### Análisis de datos faltantes en la tabla Escuelas de Jugadores


Contamos con el **100%** de nuestros datos.


```{r}
muestreo_field <- field %>% sample_n(1000)

vis_dat(muestreo_field)
vis_miss(muestreo_field)


filtrado_muestreo_base <- muestreo_field %>% 
   select(GS, InnOuts, PB, SB,CS)


vis_miss(filtrado_muestreo_base)
```

### Análisis de datos faltantes en la tabla Field

Podemos observar un número elevado de NAs en la tabla. De manera global, el porcentaje de NAs es de **29%**, lo que podría complicar nuestro análisis, pero estos se concentran en su mayoría en las columnas **GS**, **InnOuts**, **PB**, **SB** y **CS**.

En estas columnas, el porcentaje de NAs es del **64.9%**. Esto puede deberse a que no todos los jugadores tienen la misma cantidad de juegos o no todos son titulares (como en el caso de **GS**), o que su posición les haya permitido no participar en jugadas como **PB**, **SB** o **CS**.

Por lo tanto, podemos concluir que estos NAs no afectarán nuestro análisis.

```{r}
vis_dat(nombres)
vis_miss(nombres)

filtrado_muestreo_base <- nombres %>% 
   select(-deathYear, -deathMonth, -deathDay, -birthYear, -birthMonth, -birthDay, -deathCountry, -deathState, -deathCity, -deathDate)


vis_miss(filtrado_muestreo_base)
```

### Análisis de datos faltantes en la tabla Nombres

Esta tabla nos proporciona datos personales de los jugadores. Aunque tengamos un **15%** de datos faltantes, esto no afecta significativamente, ya que las columnas donde más hacen falta datos están relacionadas con la muerte del jugador.

Esta situación se explica porque la mayoría de los jugadores son jóvenes que aún están en bachillerato o en la universidad. Llegamos a esta conclusión ya que, si quitamos las columnas relacionadas con los datos de muerte, solo nos quedamos con un **1.7%** de datos faltantes, los cuales pueden deberse a errores de captura o a registros incompletos en la base de datos.



```{r}
muestreo_pitcheo <- pitcheo %>% sample_n(1000)

vis_dat(muestreo_pitcheo)
vis_miss(muestreo_pitcheo)

filtrado_muestreo_base <- muestreo_pitcheo %>% 
   select(  IBB, SH, SF, GIDP)

vis_miss(filtrado_muestreo_base)
```


### Análisis de datos faltantes en la tabla Picheo

De igual forma, en la tabla de **pitcheo** podemos observar un porcentaje de **5%** de NAs, pero estos se concentran principalmente en cuatro columnas: **IBB**, **SH**, **SF** y **GIDP**.

En estas columnas, el porcentaje de NAs es del **34%**. Esto puede deberse a que en el béisbol existen jugadas muy específicas que no todos los jugadores pueden llegar a realizar, o bien, no es común que la situación se presente debido a la posición en la que juegan.

Por lo tanto, estos datos faltantes no afectan nuestro análisis.


```{r}
vis_dat(salarios)
vis_miss(salarios)
```

### Análisis de datos faltantes en la tabla Salarios

La tabla de salarios esta completa.

```{r}
vis_dat(salonFama)
vis_miss(salonFama)

filtrado_muestreo_base <- salonFama %>% 
   select(ballots, needed, votes, needed_note)


vis_miss(filtrado_muestreo_base)
```

### Análisis de datos faltantes en la tabla Salon de la Fama


En esta tabla podemos ver que la proporción de datos faltantes es del **19.1%**, donde la mayoría de los NAs se encuentran en las columnas **ballots**, **needed**, **votes** y **needed_note**.

En estas columnas, falta aproximadamente un **43%** de los datos. Esto puede deberse a que no todos los jugadores son postulados al Salón de la Fama, o bien, que no todos los jugadores obtuvieron los votos suficientes para ingresar.



# Introducción al Análisis Exploratorio (EDA)


En esta sección realizamos un análisis exploratorio del conjunto de datos de béisbol, con el objetivo de responder diversas preguntas relacionadas con la duración de carrera, rendimiento y salarios de los jugadores. Este análisis considera información contenida en múltiples tablas como bateo, pitcheo, salarios, salonFama, entre otras, provenientes de la base de datos baseball.db.

## Pregunta 1: ¿Cuál es la duración promedio de la carrera de un jugador de béisbol profesional según su posición?

Para responder esta pregunta, necesitaremos utilizar principalmente las tablas nombres (que contiene las posiciones) y bateo (que contiene información anual del jugador). El procedimiento que seguimos fue el siguiente:

```{r}
# Calculamos la duración de la carrera de cada jugador
carrera_jugadores <- bateo |>
  group_by(playerID) |>
  summarise(
    anio_inicio = min(yearID, na.rm = TRUE),
    anio_fin = max(yearID, na.rm = TRUE),
    duracion = anio_fin - anio_inicio + 1
  )

# Obtenemos la posición más común (principal) para cada jugador desde la tabla de field
posicion_jugador <- field |>
  group_by(playerID, POS) |>
  summarise(total_partidos = sum(G, na.rm = TRUE), .groups = "drop") |>
  group_by(playerID) |>
  slice_max(order_by = total_partidos, n = 1, with_ties = FALSE) |>
  select(playerID, POS)

# Unimos la duración con la posición
jugadores_duracion_pos <- carrera_jugadores |>
  inner_join(posicion_jugador, by = "playerID")

# Calculamos el promedio de duración por posición
duracion_posicion <- jugadores_duracion_pos |>
  group_by(POS) |>
  summarise(
    promedio_duracion = mean(duracion, na.rm = TRUE),
    conteo_jugadores = n()
  )

# Ahora sí, generamos el gráfico
ggplot(duracion_posicion, aes(x = reorder(POS, promedio_duracion), y = promedio_duracion, fill = POS)) +
  geom_col(width = 0.6, show.legend = FALSE) +
  geom_text(aes(label = round(promedio_duracion, 2)), vjust = -0.5, size = 4.2, fontface = "bold") +
  ylim(0, 7) +  # ← Aumentamos el límite superior del eje Y
  labs(
    title = "Duración Promedio de la Carrera por Posición",
    subtitle = "Jugadores profesionales de béisbol según posición registrada en fielding",
    x = "Posición",
    y = "Duración promedio (años)"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold"),
    axis.text.x = element_text(face = "bold")
  )



# Mostramos la tabla final
knitr::kable(duracion_posicion, caption = "Duración promedio de la carrera según posición")

```
Para responder esta pregunta, cruzamos la información de los años de actividad de cada jugador con su posición más frecuente en el campo. Calculamos la duración de carrera como la diferencia entre el primer y último año registrado en la tabla bateo, y asignamos la posición principal con base en el mayor número de juegos disputados según la tabla field.

Los resultados muestran que:

-La posición de shortstop (SS) tiene la duración promedio más alta con 6.31 años en activo.
-Le siguen los catchers (C) y los first basemen (1B) con duraciones similares, ligeramente por encima de los 6.2 años.
-En contraste, los pitchers (P), aunque representan la mayor cantidad de jugadores en la base de datos (9,733 observaciones), tienen la duración promedio más baja con 5.36 años.

Esto puede explicarse por el desgaste físico más alto que enfrentan los lanzadores y la especialización que exige su rol, lo que puede acortar sus trayectorias comparado con otras posiciones de campo.

Además, observamos que los outfielders (OF) —que agrupan varias posiciones externas— presentan una duración promedio ligeramente inferior, lo cual puede deberse a que este grupo contiene una mezcla más diversa de trayectorias y rotaciones de jugadores.


## Pregunta 2: ¿Cómo se comparan los promedios de bateo entre jugadores que asistieron a la universidad y los que no?

```{r}
# Unimos la tabla de bateo con escuelasJugadores para saber qué jugadores fueron a la universidad
bateo_universidad <- bateo |>
  left_join(
    escuelasJugadores |> distinct(playerID) |> mutate(asistio_uni = TRUE),
    by = "playerID"
  ) |>
  mutate(asistio_uni = ifelse(is.na(asistio_uni), FALSE, TRUE))

# Calculamos el promedio de bateo (BA = H / AB) para cada jugador
promedios_jugador <- bateo_universidad |>
  group_by(playerID, asistio_uni) |>
  summarise(
    H = sum(H, na.rm = TRUE),
    AB = sum(AB, na.rm = TRUE),
    promedio_bateo = ifelse(AB > 0, H / AB, NA_real_),
    .groups = "drop"
  ) |>
  filter(!is.na(promedio_bateo))

# Resumen de estadísticas por grupo
resumen_bateo <- promedios_jugador |>
  group_by(asistio_uni) |>
  summarise(
    promedio_general = mean(promedio_bateo),
    mediana = median(promedio_bateo),
    sd = sd(promedio_bateo),
    n = n()
  )

# Visualización comparativa
ggplot(promedios_jugador, aes(x = as.factor(asistio_uni), y = promedio_bateo, fill = as.factor(asistio_uni))) +
  geom_boxplot(alpha = 0.7) +
  labs(
    title = "Comparación del promedio de bateo",
    subtitle = "Según asistencia universitaria",
    x = "¿Asistió a la universidad?",
    y = "Promedio de bateo",
    fill = "Asistencia"
  ) +
  scale_fill_manual(values = c("#999999", "#66CC66"), labels = c("No", "Sí")) +
  scale_x_discrete(labels = c("No", "Sí")) +
  theme_minimal(base_size = 13) +
  theme(plot.title = element_text(face = "bold"))

# Mostramos la tabla resumen
resumen_bateo |> knitr::kable(caption = "Promedio de bateo por grupo")

```
### Conclusiones: Comparación del promedio de bateo según asistencia universitaria
Con base en el análisis realizado, se observa que la diferencia en el promedio de bateo entre los jugadores que asistieron a la universidad y aquellos que no lo hicieron es mínima y no significativa. El promedio general de bateo para los jugadores sin estudios universitarios es de aproximadamente 0.191, mientras que para quienes sí asistieron es de 0.184. Asimismo, la mediana del promedio de bateo es apenas más alta para el grupo sin estudios universitarios (0.213 frente a 0.208).

El gráfico de caja confirma que ambas distribuciones son bastante similares en forma y dispersión, presentando valores atípicos altos en ambos casos. La desviación estándar es levemente mayor en los jugadores con estudios universitarios, lo cual indica una mayor variabilidad en su desempeño, aunque no necesariamente una diferencia sustancial.

Por lo tanto, no se evidencia una ventaja clara en términos de promedio de bateo asociada a la asistencia universitaria. Ambos grupos presentan desempeños muy parecidos, por lo que este factor no parece ser determinante en el rendimiento ofensivo medido por el promedio de bateo.


## Pregunta 3: ¿Cuál es la duración promedio de la carrera de un jugador de béisbol profesional según su posición?

```{r}
# Unimos la duración de la carrera (calculada previamente) con la información salarial
# Esto nos permitirá relacionar cuánto duró su carrera con cuánto ganaron
salario_duracion <- carrera_jugadores |> 
  inner_join(salarios, by = "playerID") |> 
  group_by(playerID, duracion) |> 
  summarise(
    salario_total = sum(salary, na.rm = TRUE),         # Suma total de salarios por jugador
    salario_promedio = mean(salary, na.rm = TRUE),     # Promedio salarial anual
    .groups = "drop"
  )

# Visualizamos si hay una relación entre la duración de la carrera y el salario total acumulado
ggplot(salario_duracion, aes(x = duracion, y = salario_total)) +
  geom_point(alpha = 0.4, size = 2, color = "#2C7BB6") +     # Puntos con transparencia
  geom_smooth(method = "lm", se = FALSE, color = "#D7191C") + # Línea de tendencia (modelo lineal)
  labs(
    title = "Relación entre duración de la carrera y salario total",
    subtitle = "Jugadores de béisbol con información salarial disponible",
    x = "Duración de la carrera (años)",
    y = "Salario total acumulado (USD)"
  ) +
  theme_minimal(base_size = 13)

# Calculamos la correlación entre los años de carrera y el salario acumulado
# Esto nos dirá si existe una asociación lineal entre ambas variables
cor.test(salario_duracion$duracion, salario_duracion$salario_total, method = "pearson")

```

### Conclusiones sobre la relación entre duración de la carrera y salario total
Se observa una tendencia creciente en el gráfico: los jugadores con carreras más largas tienden a acumular mayores ingresos totales a lo largo del tiempo. Esto se confirma visualmente mediante la línea de ajuste lineal (geom_smooth()), que tiene una pendiente positiva.

El coeficiente de correlación de Pearson entre la duración de la carrera y el salario total acumulado es de aproximadamente 0.51, lo que indica una correlación moderada y positiva entre ambas variables. En otras palabras, existe una relación directa: a mayor duración de carrera, mayor es el salario acumulado.

El valor de p < 2.2e-16 confirma que esta correlación es estadísticamente significativa, es decir, es extremadamente improbable que esta relación se deba al azar.

El intervalo de confianza del 95% para la correlación se encuentra entre 0.49 y 0.53, lo cual respalda la consistencia del resultado.


## Pregunta 4: ¿Existe una diferencia significativa en el rendimiento entre jugadores de diferentes conferencias universitarias?

```{r}
# Librerías
library(dplyr)
library(ggplot2)

# 1. Unión de bateo con la liga (renombramos para evitar el conflicto)
bateo_ligas <- bateo |>
  inner_join(field |> select(playerID, lgID_field = lgID), by = "playerID") |>
  filter(!is.na(lgID_field))  # Ahora sí usamos el nuevo nombre

# 2. Promedio de bateo por jugador y liga
promedios_ligas <- bateo_ligas |>
  group_by(playerID, lgID_field) |>
  summarise(
    H = sum(H, na.rm = TRUE),
    AB = sum(AB, na.rm = TRUE),
    promedio_bateo = ifelse(AB > 0, H / AB, NA_real_),
    .groups = "drop"
  ) |>
  filter(!is.na(promedio_bateo))

# 3. Gráfico comparativo
ggplot(promedios_ligas, aes(x = lgID_field, y = promedio_bateo, fill = lgID_field)) +
  geom_boxplot(alpha = 0.7) +
  labs(
    title = "Comparación del promedio de bateo entre ligas",
    x = "Liga",
    y = "Promedio de bateo"
  ) +
  theme_minimal(base_size = 8) +
  theme(plot.title = element_text(face = "bold"))

# 4. Prueba ANOVA para detectar diferencias
anova_ligas <- aov(promedio_bateo ~ lgID_field, data = promedios_ligas)
summary(anova_ligas)



```

### Conclusiones:
Se realizó un análisis ANOVA para evaluar si existían diferencias significativas en el promedio de bateo entre jugadores pertenecientes a distintas ligas (variable lgID_field).
El resultado del ANOVA indicó diferencias estadísticamente significativas (p < 0.001), lo que sugiere que el rendimiento de bateo promedio varía de manera significativa entre ligas.

La inspección visual del boxplot revela que, si bien la mayoría de las ligas presentan medianas de bateo similares, algunas ligas como PL y NA muestran valores medianos de bateo ligeramente superiores en comparación con ligas como AL y FL.
Sin embargo, la magnitud de las diferencias no es extrema, indicando que aunque hay un efecto de la liga en el desempeño, este efecto es modesto.

## Pregunta 5: ¿Cómo se relaciona la altura y el peso del jugador con su rendimiento en bateo?

Podemos proceder a:
-Calcular el promedio de bateo por jugador (H / AB) desde la tabla bateo.
-Cruzarlo con la tabla nombres, que contiene las columnas height y weight.
-Visualizar la relación mediante gráficos de dispersión y calcular las correlaciones.

```{r}
# Calculamos el promedio de bateo por jugador
promedios_bateo <- bateo |>
  group_by(playerID) |>
  summarise(
    H = sum(H, na.rm = TRUE),
    AB = sum(AB, na.rm = TRUE),
    promedio_bateo = ifelse(AB > 0, H / AB, NA_real_),
    .groups = "drop"
  ) |>
  filter(!is.na(promedio_bateo))

# Unimos con la tabla que contiene altura y peso
bateo_fisico <- promedios_bateo |>
  inner_join(nombres |> select(playerID, height, weight), by = "playerID") |>
  filter(!is.na(height), !is.na(weight))

# Relación entre altura y promedio de bateo
ggplot(bateo_fisico, aes(x = height, y = promedio_bateo)) +
  geom_point(alpha = 0.4, color = "steelblue") +
  geom_smooth(method = "lm", se = FALSE, color = "darkred") +
  labs(
    title = "Relación entre altura y promedio de bateo",
    x = "Altura (pulgadas)",
    y = "Promedio de bateo"
  ) +
  theme_minimal()

# Relación entre peso y promedio de bateo
ggplot(bateo_fisico, aes(x = weight, y = promedio_bateo)) +
  geom_point(alpha = 0.4, color = "darkgreen") +
  geom_smooth(method = "lm", se = FALSE, color = "darkorange") +
  labs(
    title = "Relación entre peso y promedio de bateo",
    x = "Peso (libras)",
    y = "Promedio de bateo"
  ) +
  theme_minimal()

# Correlaciones
cor.test(bateo_fisico$height, bateo_fisico$promedio_bateo)
cor.test(bateo_fisico$weight, bateo_fisico$promedio_bateo)

```
### Conclusiones:
Las gráficas y resultados estadísticos muestran que tanto la altura como el peso de los jugadores tienen una relación negativa débil con el promedio de bateo:

Altura vs. promedio de bateo:

La correlación es de aproximadamente -0.165, indicando que a mayor altura, tiende a observarse un ligero descenso en el promedio de bateo.

Aunque la relación es significativa (p < 0.001), su magnitud es baja, lo que sugiere que la altura no es un buen predictor del rendimiento en bateo por sí sola.

Peso vs. promedio de bateo:

La correlación es aún más débil, alrededor de -0.109, también con significancia estadística.

Esto indica que el peso tiene incluso menor asociación con el rendimiento en bateo.

Por lo tanto, a pesar de que ambas características físicas muestran una tendencia negativa en relación al promedio de bateo, los valores de correlación sugieren que estos factores no explican de forma sustancial el desempeño al batear. Otros aspectos como la técnica, experiencia, visión o velocidad de reacción probablemente influyen mucho más en el rendimiento.

## Pregunta 6: ¿Existe alguna tendencia de los salarios en la MLB en los últimos 50 años?


```{r}
# Agrupamos los datos por año y calculamos la media salarial por año
salarios_por_anio <- salarios |>
  group_by(yearID) |>
  summarise(
    salario_promedio = mean(salary, na.rm = TRUE),
    jugadores = n()
  ) |>
  filter(yearID >= max(yearID) - 50) # Limitamos a los últimos 50 años

# Visualizamos la tendencia de los salarios promedio
ggplot(salarios_por_anio, aes(x = yearID, y = salario_promedio)) +
  geom_line(color = "#1f78b4", size = 1.2) +
  geom_smooth(method = "lm", se = FALSE, color = "red", linewidth = 1) +
  scale_y_continuous(labels = scales::dollar_format()) +
  labs(
    title = "Tendencia de los salarios promedio en la MLB",
    subtitle = "Últimos 50 años según datos disponibles",
    x = "Año",
    y = "Salario promedio (USD)"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

```
```{r}
# Agrupar los salarios promedio por año
salarios_por_anio <- salarios |>
  group_by(yearID) |>
  summarise(salario_promedio = mean(salary, na.rm = TRUE))

# Prueba de correlación de Pearson
cor.test(salarios_por_anio$yearID, salarios_por_anio$salario_promedio, method = "pearson")

```


### Conclusión:
A lo largo de las últimas cinco décadas, los salarios promedio en la MLB han mostrado un crecimiento sostenido. Aunque con algunas fluctuaciones interanuales, la tendencia general indica que:

El salario promedio ha pasado de cifras menores al millón de dólares en los años 70 y 80, a superar los 4 millones de USD en los años recientes.

La línea de regresión lineal (en rojo) confirma esta tendencia positiva y sugiere que, en términos generales, la evolución de los salarios sigue una trayectoria ascendente significativa.

Por último, se aplicó una prueba de correlación de Pearson para examinar la relación entre el año calendario y el salario promedio de los jugadores de las Grandes Ligas de Béisbol (MLB) durante las últimas décadas. La prueba arrojó una correlación muy alta y positiva (r = 0.9847, p < 2.2e-16), lo que indica una tendencia fuertemente creciente en los salarios promedio con el paso del tiempo. Esto sugiere que los jugadores han recibido compensaciones cada vez mayores de manera sostenida a lo largo de los últimos 30 años.

##  Pregunta 7: ¿Existen disparidades salariales entre jugadores con diferentes antecedentes educativos?



```{r}
# Creamos una variable binaria indicando si un jugador asistió a la universidad
jugadores_uni <- escuelasJugadores |>
  distinct(playerID) |>
  mutate(asistio_uni = TRUE)

# Unimos la información de salarios con la de asistencia universitaria
salarios_educacion <- salarios |>
  left_join(jugadores_uni, by = "playerID") |>
  mutate(asistio_uni = ifelse(is.na(asistio_uni), FALSE, TRUE))

# Calculamos salario total y promedio por jugador
salarios_por_jugador <- salarios_educacion |>
  group_by(playerID, asistio_uni) |>
  summarise(
    salario_total = sum(salary, na.rm = TRUE),
    salario_promedio = mean(salary, na.rm = TRUE),
    .groups = "drop"
  )

# Creamos un resumen estadístico por grupo
resumen_salarios <- salarios_por_jugador |>
  group_by(asistio_uni) |>
  summarise(
    salario_prom_medio = mean(salario_promedio),
    salario_prom_mediana = median(salario_promedio),
    sd = sd(salario_promedio),
    n = n()
  )

# Mostramos la tabla resumen
knitr::kable(resumen_salarios, caption = "Resumen de salarios promedio según antecedentes educativos")

# Visualización con boxplot
ggplot(salarios_por_jugador, aes(x = as.factor(asistio_uni), y = salario_promedio, fill = as.factor(asistio_uni))) +
  geom_boxplot(alpha = 0.7) +
  scale_y_continuous(labels = scales::dollar_format()) +
  scale_fill_manual(values = c("#999999", "#66CC66"), labels = c("No", "Sí")) +
  scale_x_discrete(labels = c("No", "Sí")) +
  labs(
    title = "Comparación del salario promedio anual",
    subtitle = "Según antecedentes educativos (asistencia universitaria)",
    x = "¿Asistió a la universidad?",
    y = "Salario promedio anual (USD)",
    fill = "Asistencia"
  ) +
  theme_minimal(base_size = 13) +
  theme(plot.title = element_text(face = "bold"))

```

```{r}
wilcox.test(salario_promedio ~ asistio_uni, data = salarios_por_jugador)

```


### Conclusión – Disparidades salariales según antecedentes educativos

El análisis comparativo entre jugadores que asistieron a la universidad y aquellos que no revela ciertas diferencias en los ingresos. En promedio, los jugadores que no asistieron a la universidad perciben un salario anual más alto (1,336,455) que aquellos con antecedentes universitarios (1,048,638). Sin embargo, esta diferencia se ve matizada cuando se considera la mediana del salario, que es bastante similar para ambos grupos: 512,958 en jugadores sin universidad y 449,825 en quienes sí asistieron.

Este patrón sugiere que la diferencia en el promedio puede estar influenciada por outliers, es decir, jugadores sin estudios universitarios que perciben salarios excepcionalmente altos. Esta hipótesis se refuerza al observar que la desviación estándar del grupo sin universidad es mayor, lo cual indica una mayor dispersión en sus salarios.

Para evaluar si esta diferencia es estadísticamente significativa, se aplicó una prueba de Wilcoxon rank sum. El resultado fue:

W = 3,730,304

Valor-p < 0.000001

Este resultado nos permite rechazar la hipótesis nula de igualdad en las distribuciones de los salarios promedio anuales entre ambos grupos. En consecuencia, existe una diferencia significativa, aunque no necesariamente grande, en los salarios promedio según el antecedente educativo de los jugadores.




```{r}
summary(salarios)
```


------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Parte de Fernando ------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


## ¿La asistencia a la universidad influye en el salario del primer año de un jugador?


```{r}


primersalario <- salarios %>%  #Primer salario de cada jugador
  group_by(playerID) %>%
  slice_min(order_by = yearID, with_ties = FALSE) %>%
  ungroup()


ultimo_año <- escuelasJugadores |> group_by(playerID) |> #Df, donde viene el ultimo año de estudios de cada jugador 
                  slice_max(order_by = yearID, with_ties = FALSE) |>
                  ungroup() 


analisis <- primersalario |>
    left_join(escuelasJugadores, by = "playerID") |>
    mutate(estudios = ifelse(is.na(schoolID),  "No", "Si")) %>% #Para ver si de verded fue a la escuel el jugador
    dplyr::select(salary, estudios)

analisis$estudios <- as.factor(analisis$estudios) #Convertimos a factor para la prueb


modelo <- lm(salary ~ estudios, data = analisis)

# Realizamos la prueba de hipótesis

k_8 <- matrix(c(0, 1),  ncol=2, nrow = 1,  byrow=TRUE)


summary(glht(modelo, linfct = k_8, rhs = c(0), alternative = "greater"))




```

Nos planteamos la siguiente pregunta: ¿en promedio, un jugador que asiste a la universidad tiene un primer salario más alto que uno que no asiste?

Para responderla, realizamos un modelo de regresión lineal y una prueba de hipótesis. La evidencia estadística indica que esta hipótesis es falsa: en promedio, los jugadores que asistieron a la universidad ganan **127,811 dólares menos** que aquellos que no asistieron.

Por lo tanto, podemos concluir que si un jugador asiste a la universidad, su primer salario será, en promedio, menor que el de un jugador que no asistió.

Hagamos una gráfica para visualizarlo:




```{r}
grafica_8 <- analisis

grafica_8$salary <- log(grafica_8$salary) #Transformamos la variable a logaritmo para que se vea mejor la grafica


#esquisser(grafica_8)

ggplot(grafica_8) +
  aes(x = "", y = salary, fill = estudios) +
  geom_boxplot() +
  scale_fill_manual(
    values = c(No = "#C41C10",
    Si = "#147AA5")
  ) +
  labs(
    x = "Asistencia a la Universidad",
    y = "Primer salario en escala logaritmica",
    title = "Primer salario vs Educacion"
  ) +
  ggthemes::theme_pander() +
  theme(
    axis.text.y = element_text(size = 15L),
    axis.text.x = element_text(size = 20L),
    legend.text = element_text(size = 13L),
    legend.title = element_text(size = 20L)
  )


```






## ¿Hay alguna relación entre las estadísticas de rendimiento (promedio de bateo, home runs) y el salario?

```{r}
analisis_estadisticas <- bateo %>% #Filtrando los datos, para tener los bateos, home runs y los salarios 
  left_join(salarios, by = c("playerID", "yearID")) %>%
  filter(!is.na(salary)) %>%
  filter(AB > 0) %>%
  dplyr::select(playerID, yearID , salary, AB, HR, H ) %>%
  mutate(
    promedio_bateo = H / AB
  ) #Filtrando los datos, para tener los bateos, home runs y los salarios





resumen_por_anio <- analisis_estadisticas %>%   # Haciendo una exploracion de los datos, para ver como se han comportado los promedios a lo largo del tiempo 
  filter(!is.na(salary)) %>%
  group_by(yearID) %>%
  summarise(
    promedio_HR = mean(HR, na.rm = TRUE),
    promedio_AB = mean(AB, na.rm = TRUE),
    promedio_salario = mean(salary, na.rm = TRUE),
    n_jugadores = n()
  ) 

analisis_estadisticas

```


```{r}
modelo_sal_est = lm(salary ~ promedio_bateo + HR, data = analisis_estadisticas)



# Prueba de hipotesis 

k_9 <- matrix(c(0, 1, 0, 
                0, 0, 1),  ncol=3, nrow = 2,  byrow=TRUE)


summary(glht(modelo_sal_est, linfct = k_9, rhs = c(0, 0), alternative = "greater"))


```
De esta prueba de hipótesis podemos concluir que, en promedio, el promedio de bateo no influye tanto en el salario de un jugador. En cambio, la capacidad de completar jugadas y conectar *home runs* es lo que más contribuye a que los jugadores ganen más dinero.


```{r}
plot(modelo_sal_est)
```

```{r}

library(plotly)
library(dplyr)

# Crear una cuadrícula de valores
grid <- expand.grid(
  promedio_bateo = seq(min(analisis_estadisticas$promedio_bateo, na.rm = TRUE),
                       max(analisis_estadisticas$promedio_bateo, na.rm = TRUE),
                       length.out = 50),
  HR = seq(min(analisis_estadisticas$HR, na.rm = TRUE),
           max(analisis_estadisticas$HR, na.rm = TRUE),
           length.out = 50)
)

# Predecir sobre la cuadrícula
grid$salary_predicho <- predict(modelo_sal_est, newdata = grid)


plot_ly() %>%
  add_markers(
    data = analisis_estadisticas,
    x = ~promedio_bateo,
    y = ~HR,
    z = ~salary,
    marker = list(color = '#147AA5', size = 2),
    name = "Datos reales"
  ) %>%
  add_surface(
    x = matrix(grid$promedio_bateo, nrow = 50),
    y = matrix(grid$HR, nrow = 50),
    z = matrix(grid$salary_predicho, nrow = 50),
    showscale = FALSE,
    opacity = 0.7,
    name = "Modelo lineal"
  ) %>%
  layout(
    title = "Modelo salary ~ promedio_bateo + HR",
    scene = list(
      xaxis = list(title = "Promedio de bateo"),
      yaxis = list(title = "HR"),
      zaxis = list(title = "Salary")
    )
  )


```


En esta gráfica 3D simulamos nuestra regresión mediante un "plano de varios colores", donde los ejes X y Y representan el número de *home runs* (HR) y el promedio de bateo, respectivamente, mientras que el eje Z representa el salario.  
Los puntos azules corresponden a los jugadores a lo largo de los años que duró su carrera.

Lo que podemos observar es que el salario tiende a aumentar en proporción al número de *home runs* conectados, y no tanto al promedio de bateo. Esto sugiere que finalizar una jugada con un *home run* tiene más peso económico que simplemente batear con frecuencia.





```{r Referencia}
head(bateo)
head(escuelas)
head(escuelasJugadores)
head(field)
head(nombres)
head(pitcheo)
head(salarios)
head(salonFama)

```


## ¿Los lanzadores ganan salarios significativamente diferentes a los bateadores?


```{r}

#Ir filtrando las posiciones y los salarios de cada jugador, para saber de que juegan y cuanto ganaraon en esa posicion en cada año 

salarios_posiciones <- field %>%
  left_join(salarios, by = c("playerID", "yearID")) %>%
  filter(!is.na(salary)) %>%
  group_by(playerID,yearID,  POS) %>%
  summarise(
    salario_total = salary,
    juegos = G,
    .groups = "drop"
  ) %>%
  mutate(tipo_jugador = ifelse(POS == "P", "Lanzador", "Bateador")) %>%
  mutate(tipo_jugador = as.factor(tipo_jugador)) 


salarios_posiciones

# Obtenemos un promedio de cuanto ganaran en todos los años que jugaron en esa posicion 
salarios_acumulados <- salarios_posiciones %>%
  group_by(playerID, POS) %>%
  summarise(
    salario_total = mean(salario_total, na.rm = TRUE),
    juegos_total = sum(juegos, na.rm = TRUE),
    tipo_jugador = first(tipo_jugador),  # conservar etiqueta
    .groups = "drop"
  )

salarios_acumulados

```

```{r}
# Reliazno modelo de regresion 

modelo_salario_pos <- lm(salario_total ~ juegos_total +tipo_jugador, data = salarios_acumulados)

summary(modelo_salario_pos)
```


```{r}
esquisser(salarios_acumulados)
```



## ¿Qué factores contribuyen a la inducción al Salón de la Fama?

## ¿Existe una diferencia significativa en las tasas de entrada al Salón de la Fama entre lanzadores y bateadores?

## ¿El número de home runs aumenta las probabilidades de ingresar al Salón de la Fama?

## ¿Los jugadores de ciertas décadas tienen más probabilidades de ser incluidos al Salón de la Fama?


------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


